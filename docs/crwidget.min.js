function CRWidget(id,parentId,options){let urlAPI="https://www.cbr-xml-daily.ru/daily_json.js";let urlStyle="./crwidget-style.min.css";this.id=id;this.parentId=parentId;this.content=new Map;this.elements=new Map;this.options=this.setOptions(options);this.addStyle(urlStyle);this.request(urlAPI)}CRWidget.prototype.setOptions=function(options){let map=new Map;map.set("favorite",["USD","EUR"]);map.set("fullValue",true);map.set("deltaPic",false);if(options){for(key in options){if(map.has(key)){map.set(key,options[key])}}}return map};CRWidget.prototype.request=async function(url){try{let content=new Map;let date=new Map;let valute=new Map;let fetchOptions={credentials:"same-origin",headers:{"accept": "text/html"},method:"GET",mode:"cors", "cache": "no-cache"};let response=await fetch(url,fetchOptions);let data=await response.json();date.set("previous",formatDate(data.PreviousDate));date.set("now",formatDate(data.Date));content.set("date",date);for(key in data.Valute){valute.set(key,new Valute(data.Valute[key].ID,data.Valute[key].NumCode,data.Valute[key].CharCode,data.Valute[key].Nominal,data.Valute[key].Name,data.Valute[key].Value,data.Valute[key].Previous))}content.set("valute",valute);this.content=content;this.init()}catch(error){console.log("ERROR: "+error)}};CRWidget.prototype.init=function(){if(document.getElementById(this.parentId)){this.elements.set(this.id,new View(this.id,this.parentId,"widget"));this.elements.set(this.id+"_headers",new View(this.id+"_headers",this.id,"widget_headers"));this.elements.set(this.id+"_label",new View(this.id+"_label",this.id+"_headers","headers_label","Курсы валют"));this.content.get("date").forEach((date,key)=>{this.elements.set(this.id+"_"+key,new View(this.id+"_"+key,this.id+"_headers","headers_label",date))});this.content.get("valute").forEach((valute,key)=>{if(this.options.get("favorite").includes(key)){this.elements.set(this.id+"_"+key,new View(this.id+"_"+key,this.id,"widget_valute"))}else{this.elements.set(this.id+"_"+key,new View(this.id+"_"+key,this.id,"widget_valute__disabled"))}this.elements.set(this.id+"_"+valute.id+"_pic",new View(this.id+"_"+valute.id+"_pic",this.id+"_"+key,"valute_picture",'<img src="./img/'+key+'.png">'));this.elements.set(this.id+"_"+valute.id,new View(this.id+"_"+valute.id,this.id+"_"+key,"valute_label",valute.getCharCode(this.options)));this.elements.set(this.id+"_"+valute.id+"_previous",new View(this.id+"_"+valute.id+"_previous",this.id+"_"+key,"valute_value",valute.getPrevious(this.options)));this.elements.set(this.id+"_"+valute.id+"_value",new View(this.id+"_"+valute.id+"_value",this.id+"_"+key,"valute_value",valute.getValue(this.options)));this.elements.get(this.id+"_"+valute.id+"_pic").element.setAttribute("title",valute.name);this.elements.get(this.id+"_"+valute.id).element.setAttribute("title",valute.name)});this.elements.set(this.id+"_btnViewValute",new View(this.id+"_btnViewValute",this.id,"widget_btnViewValute","<span>Все показатели</span>"));this.elements.get(this.id+"_btnViewValute").element.addEventListener("click",this.allValute.bind(this));this.elements.set(this.id+"_footer",new View(this.id+"_footer",this.id,"widget_footer",'<a href="https://www.cbr-xml-daily.ru/">API для курсов ЦБ РФ</a>'));this.elements.forEach((element,key)=>{element.insert()})}else{console.log('The specified block id="'+this.parentId+'" is missing')}};CRWidget.prototype.addStyle=function(url){let linkSetted=false;let links=document.getElementsByTagName("link");for(var i=0;i<links.length;i++){if(links[i].href.indexOf(url.slice(2))!=-1)linkSetted=true}if(linkSetted==false){style=document.createElement("link");style.rel="stylesheet";style.type="text/css";style.href=url;document.head.appendChild(style)}};CRWidget.prototype.allValute=function(){this.content.get("valute").forEach((value,key)=>{this.elements.get(this.id+"_"+key).element.setAttribute("class","widget_valute")});this.elements.get(this.id+"_btnViewValute").element.removeEventListener("click",this.allValute);this.elements.get(this.id+"_btnViewValute").element.addEventListener("click",this.favoriteValute.bind(this));this.elements.get(this.id+"_btnViewValute").element.innerHTML="<span>Избранные показатели</span>"};CRWidget.prototype.favoriteValute=function(){this.content.get("valute").forEach((value,key)=>{if(this.options.get("favorite").includes(key)){this.elements.get(this.id+"_"+key).element.setAttribute("class","widget_valute")}else{this.elements.get(this.id+"_"+key).element.setAttribute("class","widget_valute__disabled")}});this.elements.get(this.id+"_btnViewValute").element.removeEventListener("click",this.favoriteValute);this.elements.get(this.id+"_btnViewValute").element.addEventListener("click",this.allValute.bind(this));this.elements.get(this.id+"_btnViewValute").element.innerHTML="<span>Все показатели</span>"};function Valute(id,numCode,charCode,nominal,name,value,previous){this.id=id;this.numCode=numCode;this.charCode=charCode;this.nominal=nominal;this.name=name;this.value=value;this.previous=previous}Valute.prototype.getCharCode=function(options){let str;if(options.get("deltaPic")==true){if(this.value>this.previous){str=this.charCode+'  <span class="long">▲</span>'}else if(this.value<this.previous){str=this.charCode+'  <span class="short">▼</span>'}else{str=this.charCode}}else{str=this.charCode}return str};Valute.prototype.getValue=function(options){let str;if(options.get("fullValue")==true){str=this.value.toString();if(str.slice(str.indexOf(".")+1).length!=4){str=str+"0"}}else{str=this.value.toFixed(2)}return str.replace(".",",")+" "+String.fromCharCode(8381)};Valute.prototype.getPrevious=function(options){let str;if(options.get("fullValue")==true){str=this.previous.toString();if(str.slice(str.indexOf(".")+1).length!=4){str=str+"0"}}else{str=this.previous.toFixed(2)}return str.replace(".",",")+" "+String.fromCharCode(8381)};function View(id,parentId,styleName,content=""){this.parentId=parentId;this.content=content;this.element=document.createElement("div");this.element.setAttribute("id",id);this.element.setAttribute("class",styleName)}View.prototype.insert=function(){let parent=document.getElementById(this.parentId);parent.insertAdjacentElement("beforeend",this.element);this.element.innerHTML=this.content};function formatDate(str){let format;let time=new Date(Date.parse(str)).getTime();let date=new Date(time);let day=date.getDate();let month=date.getMonth()+1;let year=date.getFullYear();if(day.toString().length==1)day="0"+day.toString();if(month.toString().length==1)month="0"+month.toString();format=day+"."+month+"."+year;return format}
