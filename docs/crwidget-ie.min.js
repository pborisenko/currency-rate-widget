function CRWidget(id,parentId,options){var urlAPI="https://www.cbr-xml-daily.ru/daily_json.js";var urlStyle="./crwidget-style.min.css";this.id=id;this.parentId=parentId;this.content={};this.elements={};this.options=this.setOptions(options);this.addStyle(urlStyle);this.request(urlAPI)}CRWidget.prototype.setOptions=function(options){var map={};map={favorite:["USD","EUR"],fullValue:true,deltaPic:false};if(options){for(key in options){if(key in map)map[key]=options[key]}}return map};CRWidget.prototype.request=function(url){var xhr=new XMLHttpRequest;xhr.open("GET",url,false);try{xhr.send();var data=JSON.parse(xhr.responseText);var content={};var date={};var valute={};date={previous:formatDate(data.PreviousDate),now:formatDate(data.Date)};for(key in data.Valute){valute[key]=new Valute(data.Valute[key].ID,data.Valute[key].NumCode,data.Valute[key].CharCode,data.Valute[key].Nominal,data.Valute[key].Name,data.Valute[key].Value,data.Valute[key].Previous)}content={date:date,valute:valute};this.content=content;this.init()}catch(error){console.log("ERROR: Request faild. "+error)}};CRWidget.prototype.init=function(){if(document.getElementById(this.parentId)){this.elements[this.id]=new View(this.id,this.parentId,"widget");this.elements[this.id+"_headers"]=new View(this.id+"_headers",this.id,"widget_headers");this.elements[this.id+"_label"]=new View(this.id+"_label",this.id+"_headers","headers_label","Курсы валют");for(var key in this.content["date"]){this.elements[this.id+"_"+key]=new View(this.id+"_"+key,this.id+"_headers","headers_label",this.content["date"][key])}for(var key in this.content["valute"]){var visible=false;for(var i=0;i<this.options["favorite"].length;i++){if(this.options["favorite"][i]==key)visible=true}if(visible==true){this.elements[this.id+"_"+key]=new View(this.id+"_"+key,this.id,"widget_valute")}else{this.elements[this.id+"_"+key]=new View(this.id+"_"+key,this.id,"widget_valute__disabled")}this.elements[this.id+"_"+this.content["valute"][key].id+"_pic"]=new View(this.id+"_"+this.content["valute"][key].id+"_pic",this.id+"_"+key,"valute_picture",'<img src="./img/'+key+'.png">');this.elements[this.id+"_"+this.content["valute"][key].id]=new View(this.id+"_"+this.content["valute"][key].id,this.id+"_"+key,"valute_label",this.content["valute"][key].getCharCode(this.options));this.elements[this.id+"_"+this.content["valute"][key].id+"_previous"]=new View(this.id+"_"+this.content["valute"][key].id+"_previous",this.id+"_"+key,"valute_value",this.content["valute"][key].getPrevious(this.options));this.elements[this.id+"_"+this.content["valute"][key].id+"_value"]=new View(this.id+"_"+this.content["valute"][key].id+"_value",this.id+"_"+key,"valute_value",this.content["valute"][key].getValue(this.options));this.elements[this.id+"_"+this.content["valute"][key].id+"_pic"].element.setAttribute("title",this.content["valute"][key].name);this.elements[this.id+"_"+this.content["valute"][key].id].element.setAttribute("title",this.content["valute"][key].name)}this.elements[this.id+"_btnViewValute"]=new View(this.id+"_btnViewValute",this.id,"widget_btnViewValute","<span>Все показатели</span>");this.elements[this.id+"_btnViewValute"].element.addEventListener("click",this.allValute.bind(this));this.elements[this.id+"_footer"]=new View(this.id+"_footer",this.id,"widget_footer",'<a href="https://www.cbr-xml-daily.ru/">API для курсов ЦБ РФ</a>');for(var key in this.elements){this.elements[key].insert()}}else{console.log('The specified block id="'+this.parentId+'" is missing')}};CRWidget.prototype.addStyle=function(url){var linkSetted=false;var links=document.getElementsByTagName("link");for(var i=0;i<links.length;i++){if(links[i].href.indexOf(url.slice(2))!=-1)linkSetted=true}if(linkSetted==false){style=document.createElement("link");style.rel="stylesheet";style.type="text/css";style.href=url;document.getElementsByTagName("head")[0].appendChild(style)}};CRWidget.prototype.allValute=function(){for(var key in this.content["valute"]){this.elements[this.id+"_"+key].element.setAttribute("class","widget_valute")}this.elements[this.id+"_btnViewValute"].element.removeEventListener("click",this.allValute);this.elements[this.id+"_btnViewValute"].element.addEventListener("click",this.favoriteValute.bind(this));this.elements[this.id+"_btnViewValute"].element.innerHTML="<span>Избранные показатели</span>"};CRWidget.prototype.favoriteValute=function(){for(var key in this.content["valute"]){if(this.options["favorite"].indexOf(key)!=-1){this.elements[this.id+"_"+key].element.setAttribute("class","widget_valute")}else{this.elements[this.id+"_"+key].element.setAttribute("class","widget_valute__disabled")}}this.elements[this.id+"_btnViewValute"].element.removeEventListener("click",this.favoriteValute);this.elements[this.id+"_btnViewValute"].element.addEventListener("click",this.allValute.bind(this));this.elements[this.id+"_btnViewValute"].element.innerHTML="<span>Все показатели</span>"};function Valute(id,numCode,charCode,nominal,name,value,previous){this.id=id;this.numCode=numCode;this.charCode=charCode;this.nominal=nominal;this.name=name;this.value=value;this.previous=previous}Valute.prototype.getCharCode=function(options){var str;if(options["deltaPic"]==true){if(this.value>this.previous){str=this.charCode+'  <span class="long">▲</span>'}else if(this.value<this.previous){str=this.charCode+'  <span class="short">▼</span>'}else{str=this.charCode}}else{str=this.charCode}return str};Valute.prototype.getValue=function(options){var str;if(options["fullValue"]==true){str=this.value.toString();if(str.slice(str.indexOf(".")+1).length!=4){str=str+"0"}}else{str=this.value.toFixed(2)}return str.replace(".",",")+" "+String.fromCharCode(8381)};Valute.prototype.getPrevious=function(options){var str;if(options["fullValue"]==true){str=this.previous.toString();if(str.slice(str.indexOf(".")+1).length!=4){str=str+"0"}}else{str=this.previous.toFixed(2)}return str.replace(".",",")+" "+String.fromCharCode(8381)};function View(id,parentId,styleName,content){this.parentId=parentId;if(content!=undefined){this.content=content}else{this.content=""}this.element=document.createElement("div");this.element.setAttribute("id",id);this.element.setAttribute("class",styleName)}View.prototype.insert=function(){var parent=document.getElementById(this.parentId);parent.insertAdjacentElement("beforeend",this.element);this.element.innerHTML=this.content};function formatDate(str){var format;var time=new Date(Date.parse(str)).getTime();var date=new Date(time);var day=date.getDate();var month=date.getMonth()+1;var year=date.getFullYear();if(day.toString().length==1)day="0"+day.toString();if(month.toString().length==1)month="0"+month.toString();format=day+"."+month+"."+year;return format}